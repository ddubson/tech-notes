# Running Malware

Malware often invokes code that is shared across the system, namely DLLs

## Dynamic Link Libraries \(DLLs\)

DLLs are a way to use libraries to share code among multiple applications.

DLLs are executable files but do not run alone, but export functions that can be used by other apps.

Windows comes prepackaged with DLLs for most common functions so that helps reduce the size of malware payloads overall.

Malware authors use DLLs in 3 ways:

1. **Store malicious code**: malicious code stored in a DLL, rather than an exe. Malware sometimes uses DLLs to load itself into another process
2. **Using Windows DLLs**: contain the functionality needed to interact with the OS.
3. **Using Third-Party DLLs**: to interact with other programs. Imports from 3rd party DLLs indicate interaction with that program.

## DLL Structure

DLL files look almost exactly like .exe files. DLLs use the PE file format and only a single flag indicates that the file is a DLL and not an EXE.

DLLs often have more exports and generally fewer imports.

The main DLL function is **DllMain -** has no label and is not an export in the DLL but is specified in the PE header as the fileâ€™s entry point.

* the function is called to notify the DLL whenever a process loads or unloads the library, creates a new thread, or finishes an existing thread.
* Allows the DLL to manage any per-process or per-thread resources.
* DLLs do not have per-thread resources, and they ignore calls to DLLMain that are caused by thread activity.

### Creating a new Process

Function most commonly used is `CreateProcess` - call this function  to create a process to execute its malicious code, to bypass firewalls

May use create process to create a remote shell

May create a new process by storing one program inside another in the resource section

